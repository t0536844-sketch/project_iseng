<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Pengolahan Data RL 5.5 Rekam Medis</title>
    <script type="text/javascript" src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); max-width: 1000px; margin: auto; }
        h1, h2 { color: #333; }
        table { width: 100%; border-collapse: collapse; margin-top: 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        
        /* Gaya Header Tabel Standar */
        th { background-color: #4CAF50; color: white; }
        
        /* Header khusus untuk tabel filter usia */
        #customAgeFilterTable thead th { background-color: #ff9800 !important; color: white; } 
        
        /* New Scrollable Table Container Style */
        .scrollable-table-container {
            max-height: 400px; /* Tinggi Maksimum Scroll */
            overflow-y: auto; /* Mengaktifkan Scroll Vertikal */
            border: 1px solid #ddd; 
            margin-top: 10px;
        }
        
        /* Membuat Header Tabel Sticky (tetap terlihat saat scroll) */
        .scrollable-table-container table thead th {
             position: sticky; 
             top: 0;
             z-index: 10;
        }

        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, input[type="number"], input[type="file"] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .button-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; margin-bottom: 15px; }
        button { color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { opacity: 0.9; }
        
        #resetAllButton { background-color: #f44336; }
        .reset-section-button { background-color: #cc0000; }
        
        .download-csv { background-color: #2196F3; }
        .download-xlsx { background-color: #008000; }
        
        /* Dashboard Styling */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .dashboard-card { background: #f9f9f9; padding: 15px; border-radius: 6px; border: 1px solid #eee; text-align: center; }
        .kpi-card { grid-column: 1 / 3; background: #e0f7fa; border-left: 5px solid #00bcd4; }
        .kpi-value { font-size: 2.5em; font-weight: bold; color: #00bcd4; margin: 5px 0; }
        .chart-container { height: 400px; background: #fff; padding: 10px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        @media (max-width: 768px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            .kpi-card { grid-column: 1 / 2; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1 style="text-align: center; background-color: pink; padding: 10px;">RUMAH SAKIT UMUM DAERAH KABUPATEN MIMIKA</h1>
    <h2 style="text-align: center; background-color: lightyellow; padding: 10px;">DASHBOARD PENGOLAHAN DATA RL 5.5 REKAM MEDIK</h2>

    <div class="dashboard-grid">
        <div class="dashboard-card kpi-card">
            <h3>Total Kasus Keseluruhan yang Diolah</h3>
            <div class="kpi-value" id="totalKasusKPI">0</div>
            <p>Data diambil dari semua baris dan kelompok usia.</p>
        </div>
        
        <div class="dashboard-card">
            <h3>Top 10 Penyakit (Total Kasus)</h3>
            <div class="chart-container">
                <canvas id="top10Chart"></canvas>
            </div>
        </div>
        
        <div class="dashboard-card">
            <h3>Distribusi Kasus Berdasarkan Filter Usia Khusus</h3>
            <div class="chart-container">
                <canvas id="ageDistributionChart"></canvas>
            </div>
        </div>
    </div>
    <div class="upload-section">
        <h2>Opsi 1: Unggah File Excel/CSV (Format RL 5.5)</h2>
        <p>Unggah file Excel/CSV. Sistem akan otomatis menggabungkan data dari kolom usia/jenis kelamin menjadi **6 kelompok usia standar**.</p>
        <input type="file" id="fileInput" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" onchange="handleFileUpload()">
    </div>
    
    <h2>Opsi 2: Input Manual</h2>
    <p>Gunakan ini untuk menambah kasus pada kelompok usia standar.</p>
    <div class="form-group">
        <label for="kodePenyakit">Kode ICD-10:</label>
        <input type="text" id="kodePenyakit" placeholder="Contoh: A09" required>
    </div>
    <div class="form-group">
        <label for="namaPenyakit">Nama Penyakit (Diagnosa):</label>
        <input type="text" id="namaPenyakit" placeholder="Contoh: Diare dan Gastroenteritis" required>
    </div>
    <div class="form-group">
        <label for="jumlahKasus">Jumlah Kasus:</label>
        <input type="number" id="jumlahKasus" min="0" value="0" required>
    </div>
    <div class="form-group">
        <label for="rentangUsia">Rentang Usia:</label>
        <select id="rentangUsia" required>
            <option value="">-- Pilih Rentang Usia --</option>
            <option value="0-4 tahun">0-4 tahun</option>
            <option value="5-14 tahun">5-14 tahun</option>
            <option value="15-24 tahun">15-24 tahun</option>
            <option value="25-44 tahun">25-44 tahun</option>
            <option value="45-64 tahun">45-64 tahun</option>
            <option value="65+ tahun">65+ tahun</option>
        </select>
    </div>
    <button onclick="addData()">Tambahkan Data</button>
    
    <hr>
    
    <h2>Tabel Filter Usia Khusus</h2>
    <div class="button-group">
        <button class="download-csv" onclick="downloadCustomAgeFilterCSV()">Unduh Filter (CSV)</button>
        <button class="download-xlsx" onclick="downloadCustomAgeFilterExcel()">Unduh Filter (Excel)</button>
        <button class="reset-section-button" onclick="resetData()">Bersihkan Semua Data</button>
    </div>
    <p>Ringkasan kasus per ICD-10 berdasarkan kelompok usia khusus (0-4, 5-14, 15-44, 45+ tahun).</p>
    <div class="scrollable-table-container">
        <table>
            <thead>
                <tr>
                    <th>No.</th>
                    <th>Kode ICD-10</th>
                    <th>Nama Penyakit</th>
                    <th>0-4 Tahun</th>
                    <th>5-14 Tahun</th>
                    <th>15-44 Tahun</th>
                    <th>45+ Tahun</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody id="customAgeFilterTableBody">
                </tbody>
        </table>
    </div>

    <hr>
    
    <h2>Laporan Ringkasan Usia per ICD-10 (Detail)</h2>
    <div class="button-group">
        <button class="download-csv" onclick="downloadAgeSummaryCSV()">Unduh Ringkasan (CSV)</button>
        <button class="download-xlsx" onclick="downloadAgeSummaryExcel()">Unduh Ringkasan (Excel)</button>
        <button class="reset-section-button" onclick="resetData()">Bersihkan Semua Data</button>
    </div>
    <p>Tabel ini menampilkan detail jumlah kasus per Kode ICD-10 dan Kelompok Usia Standar (6 Kelompok).</p>
    <div class="scrollable-table-container">
        <table>
            <thead>
                <tr>
                    <th>No.</th>
                    <th>Kode ICD-10</th>
                    <th>Nama Penyakit</th>
                    <th>Rentang Usia</th>
                    <th>Jumlah Kasus</th>
                </tr>
            </thead>
            <tbody id="ageSummaryTableBody">
                </tbody>
        </table>
    </div>
    
    <hr>
    
    <h2>Laporan RL 5.5 (Top 10 Penyakit)</h2>
    <div class="button-group">
        <button id="resetAllButton" onclick="resetData()">Bersihkan Semua Data</button>
        <button class="download-csv" onclick="downloadReportCSV()">Unduh Laporan Top 10 (CSV)</button>
        <button class="download-xlsx" onclick="downloadReportExcel()">Unduh Laporan Top 10 (Excel)</button>
    </div>
    <p>ðŸ’¡ Menampilkan 10 Penyakit Teratas berdasarkan **Total Jumlah Kasus**.</p>
    <table>
        <thead>
            <tr>
                <th>No.</th>
                <th>Kode ICD-10</th>
                <th>Nama Penyakit (Diagnosa)</th>
                <th>Total Kasus</th>
            </tr>
        </thead>
        <tbody id="dataTableBody">
            </tbody>
    </table>
</div>

<script>
    let dataList = []; 
    const dataTableBody = document.getElementById('dataTableBody');
    const ageSummaryTableBody = document.getElementById('ageSummaryTableBody');
    const customAgeFilterTableBody = document.getElementById('customAgeFilterTableBody');
    
    let top10ChartInstance = null;
    let ageDistributionChartInstance = null;

    // Kelompok Usia Standar dan Urutan untuk Sorting
    const ageOrder = ["0-4 tahun", "5-14 tahun", "15-24 tahun", "25-44 tahun", "45-64 tahun", "65+ tahun"];

    // Mapping Kolom RL 5.5 (Wide Data) ke Kelompok Usia Standar (Long Data)
    const AGE_GROUP_MAPPING = [
        { name: "0-4 tahun", indices: [2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17] }, 
        { name: "5-14 tahun", indices: [18, 19, 20, 21] }, 
        { name: "15-24 tahun", indices: [22, 23, 24, 25] }, 
        { name: "25-44 tahun", indices: [26, 27, 28, 29, 30, 31, 32, 33] }, 
        { name: "45-64 tahun", indices: [34, 35, 36, 37, 38, 39, 40, 41] }, 
        { name: "65+ tahun", indices: [42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53] }
    ];

    // --- Fungsi Utama dan Logika Data ---
    
    function addData() {
        const kodePenyakit = document.getElementById('kodePenyakit').value;
        const namaPenyakit = document.getElementById('namaPenyakit').value;
        const jumlahKasus = parseInt(document.getElementById('jumlahKasus').value);
        const rentangUsia = document.getElementById('rentangUsia').value;

        if (kodePenyakit && namaPenyakit && jumlahKasus >= 0 && rentangUsia) {
            
            dataList.push({ 
                kode: kodePenyakit.trim(), 
                nama: namaPenyakit.trim(), 
                jumlah: jumlahKasus,
                usia: rentangUsia 
            });
            
            dataList = mergeDuplicateCodesAndAges(dataList); 
            renderDashboardAndTables(); 
            clearForm();
        } else {
            alert('Mohon lengkapi semua field dengan benar.');
        }
    }

    function clearForm() {
        document.getElementById('kodePenyakit').value = '';
        document.getElementById('namaPenyakit').value = '';
        document.getElementById('jumlahKasus').value = '0';
        document.getElementById('rentangUsia').value = '';
    }

    function handleFileUpload() {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        if (!file) {
            alert("Mohon pilih file terlebih dahulu.");
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) { 
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {
                    type: 'array',
                    cellDates: false, 
                    cellStyles: false
                });
                
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                const jsonSheetData = XLSX.utils.sheet_to_json(worksheet, { 
                    header: 1, 
                    raw: false 
                });

                processExcelData(jsonSheetData);
            } catch (error) {
                alert("Gagal memproses file. Pastikan format file (Excel/CSV) benar dan sesuai format RL 5.5.");
                console.error("Error processing file:", error);
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function processExcelData(excelData) {
        let uploadedData = []; 
        
        for (let i = 1; i < excelData.length; i++) {
            const row = excelData[i];
            
            const kode = String(row[0] || '').trim();
            const nama = String(row[1] || '').trim();

            if (!kode || !nama) continue; 

            // Agregasi (Pivoting) kolom usia/jenis kelamin ke 6 kelompok standar
            AGE_GROUP_MAPPING.forEach(group => {
                let totalKasusUsia = 0;
                
                group.indices.forEach(colIndex => {
                    const kasus = parseInt(String(row[colIndex] || '0').trim());
                    if (!isNaN(kasus) && kasus > 0) {
                        totalKasusUsia += kasus;
                    }
                });
                
                if (totalKasusUsia > 0) {
                    uploadedData.push({ 
                        kode: kode, 
                        nama: nama, 
                        jumlah: totalKasusUsia, 
                        usia: group.name 
                    });
                }
            });
        }
        
        dataList = mergeDuplicateCodesAndAges(uploadedData); 
        renderDashboardAndTables();
        alert(`Data dari file RL 5.5 (${dataList.length} baris unik Kode/Usia) berhasil dimuat.`);
        document.getElementById('fileInput').value = '';
    }

    function mergeDuplicateCodesAndAges(list) {
        const map = new Map();
        list.forEach(item => {
            const key = `${item.kode.toUpperCase()}-${item.usia.toLowerCase()}`; 
            if (map.has(key)) {
                map.get(key).jumlah += item.jumlah;
            } else {
                map.set(key, { ...item }); 
            }
        });
        return Array.from(map.values());
    }

    function resetData() {
        if (confirm('Anda yakin ingin menghapus semua data yang ada? Aksi ini tidak dapat dibatalkan.')) {
            dataList = [];
            renderDashboardAndTables();
            document.getElementById('fileInput').value = ''; 
            alert('Semua data berhasil dibersihkan.');
        }
    }

    // --- Fungsi Render Dashboard (BARU) ---
    function renderDashboard() {
        const totalKasus = dataList.reduce((sum, item) => sum + item.jumlah, 0);
        document.getElementById('totalKasusKPI').innerText = totalKasus.toLocaleString('id-ID');

        const top10Data = getTop10DataForDownload();
        renderTop10Chart(top10Data);

        const customAgeData = getCustomAgeFilterDataForDownload();
        renderAgeDistributionChart(customAgeData);
    }

    function renderTop10Chart(data) {
        const labels = data.map(d => `${d.kode} - ${d.nama}`);
        const totals = data.map(d => d.total);
        const ctx = document.getElementById('top10Chart').getContext('2d');
        
        // Hancurkan instance chart lama jika ada
        if (top10ChartInstance) {
            top10ChartInstance.destroy();
        }

        top10ChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Total Kasus',
                    data: totals,
                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                scales: {
                    x: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'Top 10 Penyakit Berdasarkan Total Kasus'
                    }
                }
            }
        });
    }

    function renderAgeDistributionChart(allCustomAgeData) {
        const ageGroups = ['0-4 tahun', '5-14 tahun', '15-44 tahun', '45+ tahun'];
        let totals = {
            '0-4 tahun': 0,
            '5-14 tahun': 0,
            '15-44 tahun': 0,
            '45+ tahun': 0
        };

        // Agregasi total kasus dari semua ICD untuk setiap kelompok usia custom
        allCustomAgeData.forEach(item => {
            totals['0-4 tahun'] += item['0-4 tahun'];
            totals['5-14 tahun'] += item['5-14 tahun'];
            totals['15-44 tahun'] += item['15-44 tahun'];
            totals['45+ tahun'] += item['45+ tahun'];
        });

        const dataPoints = ageGroups.map(group => totals[group]);
        const ctx = document.getElementById('ageDistributionChart').getContext('2d');

        // Hancurkan instance chart lama jika ada
        if (ageDistributionChartInstance) {
            ageDistributionChartInstance.destroy();
        }

        ageDistributionChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ageGroups,
                datasets: [{
                    data: dataPoints,
                    backgroundColor: [
                        '#FF6384', // Merah
                        '#36A2EB', // Biru
                        '#FFCE56', // Kuning
                        '#4BC0C0'  // Hijau
                    ],
                    hoverBackgroundColor: [
                        '#FF6384',
                        '#36A2EB',
                        '#FFCE56',
                        '#4BC0C0'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                    },
                    title: {
                        display: true,
                        text: 'Persentase Kasus per Kelompok Usia Khusus'
                    }
                }
            }
        });
    }


    // --- Fungsi Render Tabel ---
    
    function renderCustomAgeFilterTable() {
        customAgeFilterTableBody.innerHTML = '';
        const customFilteredData = getCustomAgeFilterDataForDownload()
            .sort((a, b) => b.total - a.total); // Pastikan tabel juga terurut

        if (customFilteredData.length === 0) {
            customAgeFilterTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Tidak ada data yang sesuai filter usia khusus.</td></tr>';
            return;
        }

        customFilteredData.forEach((data, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${data.kode}</td>
                <td>${data.nama}</td>
                <td>${data['0-4 tahun']}</td>
                <td>${data['5-14 tahun']}</td>
                <td>${data['15-44 tahun']}</td>
                <td>${data['45+ tahun']}</td>
                <td>${data.total}</td>
            `;
            customAgeFilterTableBody.appendChild(row);
        });
    }

    function renderTableRL55() {
        dataTableBody.innerHTML = '';
        const top10Data = getTop10DataForDownload();

        if (top10Data.length === 0) {
            dataTableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Tidak ada data RL 5.5 yang tersedia.</td></tr>';
            return;
        }

        top10Data.forEach((data, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${data.kode}</td>
                <td>${data.nama}</td>
                <td>${data.total}</td>
            `;
            dataTableBody.appendChild(row);
        });
    }
    
    function renderAgeSummaryTable() {
        ageSummaryTableBody.innerHTML = '';
        const filteredAndSortedData = getAgeSummaryDataForDownload();

        if (filteredAndSortedData.length === 0) {
            ageSummaryTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Tidak ada data kasus per rentang usia.</td></tr>';
            return;
        }

        filteredAndSortedData.forEach((data, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${data.kode}</td>
                <td>${data.nama}</td>
                <td>${data.usia}</td>
                <td>${data.jumlah}</td>
            `;
            ageSummaryTableBody.appendChild(row);
        });
    }

    // Fungsi utama untuk me-render semua elemen
    function renderDashboardAndTables() {
        renderDashboard();
        renderTableRL55();
        renderAgeSummaryTable();
        renderCustomAgeFilterTable();
    }
    
    // --- Fungsi Bantuan Download ---
    
    function getAgeSummaryDataForDownload() {
         return [...dataList]
            .filter(item => item.jumlah > 0)
            .sort((a, b) => {
                if (a.kode < b.kode) return -1;
                if (a.kode > b.kode) return 1;
                return ageOrder.indexOf(a.usia) - ageOrder.indexOf(b.usia);
            });
    }
    
    function getTop10DataForDownload() {
        if (dataList.length === 0) return [];

        const totalCasesPerICD = new Map();
        dataList.forEach(item => {
            const currentTotal = totalCasesPerICD.get(item.kode) || { kode: item.kode, nama: item.nama, total: 0 };
            currentTotal.total += item.jumlah;
            currentTotal.nama = item.nama;
            totalCasesPerICD.set(item.kode, currentTotal);
        });
        const aggregatedData = Array.from(totalCasesPerICD.values());
        const sortedData = aggregatedData.sort((a, b) => b.total - a.total); 
        return sortedData.slice(0, 10);
    }

    function getCustomAgeFilterDataForDownload() {
        const customAgeMap = new Map();
        dataList.forEach(item => {
            const kode = item.kode;
            const nama = item.nama;
            const jumlah = item.jumlah;
            const usiaStandar = item.usia;
            let usiaCustom;

            if (usiaStandar === "0-4 tahun") {
                usiaCustom = "0-4 tahun";
            } else if (usiaStandar === "5-14 tahun") {
                usiaCustom = "5-14 tahun";
            } else if (usiaStandar === "15-24 tahun" || usiaStandar === "25-44 tahun") {
                usiaCustom = "15-44 tahun";
            } else if (usiaStandar === "45-64 tahun" || usiaStandar === "65+ tahun") {
                usiaCustom = "45+ tahun";
            } else {
                return;
            }

            const key = kode.toUpperCase(); 
            
            if (!customAgeMap.has(key)) {
                customAgeMap.set(key, {
                    kode: kode,
                    nama: nama,
                    '0-4 tahun': 0,
                    '5-14 tahun': 0,
                    '15-44 tahun': 0,
                    '45+ tahun': 0,
                    total: 0
                });
            }

            const entry = customAgeMap.get(key);
            entry[usiaCustom] += jumlah;
            entry.total += jumlah;
            entry.nama = nama; 
        });

        // Filter data hanya untuk kode yang memiliki kasus > 0 di setidaknya satu kelompok usia
        return Array.from(customAgeMap.values())
            .filter(item => item.total > 0);
    }

    // --- Fungsi Download: Ringkasan Usia (Detail) ---

    function downloadAgeSummaryCSV() {
        const data = getAgeSummaryDataForDownload();
        if (data.length === 0) {
            alert('Tidak ada data untuk diunduh.');
            return;
        }
        
        let csvContent = "No.,Kode ICD-10,Nama Penyakit (Diagnosa),Rentang Usia,Jumlah Kasus\n";
        data.forEach((item, index) => {
            const namaPenyakitClean = item.nama.replace(/"/g, '""'); 
            csvContent += `${index + 1},${item.kode},"${namaPenyakitClean}",${item.usia},${item.jumlah}\n`;
        });
        downloadFile(csvContent, "Laporan_Ringkasan_Usia.csv", 'text/csv;charset=utf-8;');
    }
    
    function downloadAgeSummaryExcel() {
        const data = getAgeSummaryDataForDownload();
        if (data.length === 0) {
            alert('Tidak ada data untuk diunduh.');
            return;
        }
        
        const AoA = [
            ["No.", "Kode ICD-10", "Nama Penyakit (Diagnosa)", "Rentang Usia", "Jumlah Kasus"]
        ];
        data.forEach((item, index) => {
            AoA.push([index + 1, item.kode, item.nama, item.usia, item.jumlah]);
        });

        const worksheet = XLSX.utils.aoa_to_sheet(AoA);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Ringkasan Usia");
        
        XLSX.writeFile(workbook, "Laporan_Ringkasan_Usia.xlsx");
    }

    // --- Fungsi Download: Filter Usia Khusus ---

    function downloadCustomAgeFilterCSV() {
        const data = getCustomAgeFilterDataForDownload()
            .sort((a, b) => b.total - a.total); // Urutkan sebelum diunduh
        if (data.length === 0) {
            alert('Tidak ada data untuk diunduh.');
            return;
        }
        
        let csvContent = "No.,Kode ICD-10,Nama Penyakit (Diagnosa),0-4 Tahun,5-14 Tahun,15-44 Tahun,45+ Tahun,Total\n";
        data.forEach((item, index) => {
            const namaPenyakitClean = item.nama.replace(/"/g, '""'); 
            csvContent += `${index + 1},${item.kode},"${namaPenyakitClean}",${item['0-4 tahun']},${item['5-14 tahun']},${item['15-44 tahun']},${item['45+ tahun']},${item.total}\n`;
        });
        downloadFile(csvContent, "Laporan_Filter_Usia_Khusus.csv", 'text/csv;charset=utf-8;');
    }
    
    function downloadCustomAgeFilterExcel() {
        const data = getCustomAgeFilterDataForDownload()
             .sort((a, b) => b.total - a.total); // Urutkan sebelum diunduh
        if (data.length === 0) {
            alert('Tidak ada data untuk diunduh.');
            return;
        }
        
        const AoA = [
            ["No.", "Kode ICD-10", "Nama Penyakit (Diagnosa)", "0-4 Tahun", "5-14 Tahun", "15-44 Tahun", "45+ Tahun", "Total"]
        ];
        data.forEach((item, index) => {
            AoA.push([index + 1, item.kode, item.nama, item['0-4 tahun'], item['5-14 tahun'], item['15-44 tahun'], item['45+ tahun'], item.total]);
        });

        const worksheet = XLSX.utils.aoa_to_sheet(AoA);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Filter Usia Khusus");
        
        XLSX.writeFile(workbook, "Laporan_Filter_Usia_Khusus.xlsx");
    }


    // --- Fungsi Download: Top 10 (RL 5.5) ---

    function downloadReportCSV() {
        const top10Data = getTop10DataForDownload();
        if (top10Data.length === 0) {
            alert('Tidak ada data Top 10 untuk diunduh.');
            return;
        }
        
        let csvContent = "No.,Kode ICD-10,Nama Penyakit (Diagnosa),Total Kasus\n";
        top10Data.forEach((data, index) => {
            const namaPenyakitClean = data.nama.replace(/"/g, '""'); 
            csvContent += `${index + 1},${data.kode},"${namaPenyakitClean}",${data.total}\n`;
        });
        downloadFile(csvContent, "Laporan_RL5_5_Top10.csv", 'text/csv;charset=utf-8;');
    }
    
    function downloadReportExcel() {
        const top10Data = getTop10DataForDownload();
        if (top10Data.length === 0) {
            alert('Tidak ada data Top 10 untuk diunduh.');
            return;
        }
        
        const AoA = [
            ["No.", "Kode ICD-10", "Nama Penyakit (Diagnosa)", "Total Kasus"]
        ];
        top10Data.forEach((data, index) => {
            AoA.push([index + 1, data.kode, data.nama, data.total]);
        });

        const worksheet = XLSX.utils.aoa_to_sheet(AoA);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Top 10 Penyakit");
        
        XLSX.writeFile(workbook, "Laporan_RL5_5_Top10.xlsx");
    }


    // --- Fungsi Unduhan Generik ---
    function downloadFile(content, fileName, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", fileName);
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Inisialisasi tampilan tabel dan dashboard saat halaman dimuat
    document.addEventListener('DOMContentLoaded', renderDashboardAndTables);
</script>

</body>
</html>